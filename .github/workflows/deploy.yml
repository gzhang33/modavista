# 工作流名称
name: Deploy to InfinityFree

# 触发条件：当代码被推送到 main 分支时触发
on:
  push:
    branches:
      - main  # 您可以更改为您想部署的分支，比如 master

# 任务
jobs:
  ftp-deploy:
    # 任务名称
    name: FTP Deploy
    # 运行环境：使用最新的 Ubuntu 系统
    runs-on: ubuntu-latest

    env:
      FTP_SERVER: ${{ secrets.FTP_SERVER }}
      FTP_USERNAME: ${{ secrets.FTP_USERNAME }}
      FTP_PASSWORD: ${{ secrets.FTP_PASSWORD }}

    steps:
    # 第一步：检出代码
    - name: Checkout code
      uses: actions/checkout@v4

    # 预检查：如果缺少必要的 Secrets，则跳过部署并给出提示
    - name: Check required secrets
      if: ${{ env.FTP_SERVER == '' || env.FTP_USERNAME == '' || env.FTP_PASSWORD == '' }}
      run: |
        echo "Missing one or more required secrets: FTP_SERVER / FTP_USERNAME / FTP_PASSWORD" >&2
        echo "Set them in GitHub → Settings → Secrets and variables → Actions" >&2
        echo "Skipping deploy." >&2

    # 部署到 FTP 服务器（仅当全部 Secrets 存在时执行）
    - name: FTP Deploy
      if: ${{ env.FTP_SERVER != '' && env.FTP_USERNAME != '' && env.FTP_PASSWORD != '' }}
      uses: SamKirkland/FTP-Deploy-Action@v4.3.4
      with:
        server: ${{ env.FTP_SERVER }}
        username: ${{ env.FTP_USERNAME }}
        password: ${{ env.FTP_PASSWORD }}
        protocol: ftps
        server-dir: /htdocs/
        exclude: |
          **/.git/**
          **/.git*
          **/.github/**
          .gitignore
          README.md
          README.txt
          .cursorrules
          CURSORRULES.txt
          api/config.php

