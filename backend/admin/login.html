<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>管理后台登录 · Dreamoda</title>
    <link rel="stylesheet" href="assets/css/base.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            color-scheme: light;
            --primary-500: #6366f1;
            --primary-600: #4f46e5;
            --primary-700: #4338ca;
            --neutral-50: #f9fafb;
            --neutral-100: #f3f4f6;
            --neutral-200: #e5e7eb;
            --neutral-600: #4b5563;
            --neutral-700: #374151;
            --neutral-900: #111827;
            --success-500: #10b981;
            --error-500: #ef4444;
            --warning-500: #f59e0b;
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            min-height: 100vh;
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 32px 16px;
            background: radial-gradient(circle at top, rgba(79, 70, 229, 0.15), transparent 55%),
                        radial-gradient(circle at bottom, rgba(99, 102, 241, 0.12), transparent 45%),
                        linear-gradient(135deg, #eef2ff 0%, #f5f3ff 100%);
        }

        .auth-shell {
            width: 100%;
            max-width: 520px;
            display: grid;
            grid-template-columns: minmax(0, 1fr);
            gap: 24px;
            align-items: stretch;
        }

        .auth-card {
            background: rgba(255, 255, 255, 0.92);
            border-radius: 24px;
            backdrop-filter: blur(18px);
            border: 1px solid rgba(255, 255, 255, 0.6);
            box-shadow: 0 32px 64px -20px rgba(79, 70, 229, 0.25);
            overflow: hidden;
            position: relative;
        }

        .auth-card::after {
            content: '';
            position: absolute;
            inset: 0;
            border-radius: inherit;
            border: 1px solid rgba(99, 102, 241, 0.15);
            pointer-events: none;
        }

        .auth-content {
            padding: 48px 44px;
        }

        .auth-brand {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 32px;
        }

        .auth-badge {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            padding: 12px 16px;
            border-radius: 14px;
            background: rgba(79, 70, 229, 0.08);
            font-size: 13px;
            font-weight: 600;
            color: var(--primary-600);
            width: fit-content;
        }

        .auth-title {
            font-size: 28px;
            font-weight: 700;
            letter-spacing: -0.02em;
            color: var(--neutral-900);
            margin: 0;
        }

        .auth-subtitle {
            font-size: 15px;
            color: var(--neutral-600);
            margin: 0;
        }

        .step-header {
            display: flex;
            flex-direction: column;
            gap: 6px;
            margin-bottom: 24px;
        }

        .step-indicator {
            font-size: 13px;
            font-weight: 600;
            color: var(--primary-600);
            text-transform: uppercase;
            letter-spacing: 0.08em;
        }

        .step-title {
            font-size: 22px;
            font-weight: 700;
            color: var(--neutral-900);
            margin: 0;
        }

        .step-subtitle {
            font-size: 15px;
            color: var(--neutral-600);
            margin: 0;
        }

        .auth-form {
            display: flex;
            flex-direction: column;
            gap: 18px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .form-label {
            font-size: 14px;
            font-weight: 600;
            color: var(--neutral-700);
        }

        .form-control {
            width: 100%;
            font-size: 15px;
            line-height: 22px;
            padding: 14px 16px;
            border-radius: 14px;
            border: 1.5px solid var(--neutral-200);
            background: rgba(255, 255, 255, 0.9);
            color: var(--neutral-900);
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary-500);
            box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.12);
            background: #fff;
        }

        .form-control::placeholder {
            color: #9ca3af;
        }

        .totp-input {
            font-size: 24px;
            letter-spacing: 8px;
            text-align: center;
            padding: 16px 20px;
        }

        .form-hint {
            font-size: 13px;
            color: var(--neutral-600);
            margin-top: 10px;
            line-height: 1.6;
        }

        .recovery-hint {
            margin-top: 14px;
            padding: 14px 16px;
            border-radius: 16px;
            background: rgba(99, 102, 241, 0.08);
            color: var(--neutral-700);
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .recovery-hint strong {
            font-size: 13px;
            letter-spacing: 0.02em;
        }

        .recovery-hint ul {
            margin: 0;
            padding-left: 18px;
            display: grid;
            gap: 4px;
        }

        .recovery-hint code {
            font-family: 'Fira Code', 'JetBrains Mono', 'Courier New', monospace;
            font-size: 13px;
            background: rgba(255, 255, 255, 0.6);
            padding: 2px 6px;
            border-radius: 6px;
        }

        .recovery-hint p {
            margin: 0;
            font-size: 12px;
            color: var(--neutral-600);
        }

        .totp-input.is-recovery {
            letter-spacing: 2px;
            font-size: 20px;
            text-transform: uppercase;
        }

        .checkbox-row {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 14px;
            color: var(--neutral-600);
        }

        .checkbox-row input[type="checkbox"] {
            width: 18px;
            height: 18px;
            border-radius: 6px;
            border: 1.5px solid var(--neutral-200);
            accent-color: var(--primary-600);
        }

        .auth-actions {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .primary-button {
            border: none;
            border-radius: 14px;
            padding: 14px 18px;
            font-size: 15px;
            font-weight: 600;
            color: #fff;
            cursor: pointer;
            background: linear-gradient(135deg, var(--primary-600), var(--primary-500));
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .primary-button:hover {
            transform: translateY(-1px);
            box-shadow: 0 12px 24px -12px rgba(79, 70, 229, 0.55);
        }

        .primary-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .ghost-button {
            border: none;
            background: transparent;
            color: var(--neutral-600);
            font-size: 14px;
            font-weight: 600;
            padding: 0;
            cursor: pointer;
            text-decoration: underline;
            text-decoration-style: dotted;
        }

        .auth-message {
            border-radius: 16px;
            padding: 14px 16px;
            font-size: 14px;
            line-height: 1.5;
            display: flex;
            gap: 12px;
            align-items: flex-start;
        }

        .auth-message[data-type="success"] {
            background: rgba(16, 185, 129, 0.12);
            border: 1px solid rgba(16, 185, 129, 0.35);
            color: var(--success-500);
        }

        .auth-message[data-type="error"] {
            background: rgba(239, 68, 68, 0.12);
            border: 1px solid rgba(239, 68, 68, 0.35);
            color: var(--error-500);
        }

        .auth-message[data-type="info"] {
            background: rgba(79, 70, 229, 0.12);
            border: 1px solid rgba(79, 70, 229, 0.35);
            color: var(--primary-600);
        }

        .auth-message[data-type="warning"] {
            background: rgba(245, 158, 11, 0.12);
            border: 1px solid rgba(245, 158, 11, 0.35);
            color: var(--warning-500);
        }

        .auth-footer {
            margin-top: 24px;
            font-size: 13px;
            color: var(--neutral-500);
            text-align: center;
        }

        .is-hidden {
            display: none !important;
        }

        @media (max-width: 640px) {
            body {
                padding: 24px 12px;
            }

            .auth-content {
                padding: 32px 24px;
            }

            .auth-title {
                font-size: 24px;
            }

            .step-title {
                font-size: 20px;
            }

            .totp-input {
                letter-spacing: 6px;
                font-size: 22px;
            }
        }
    </style>
</head>
<body>
    <div class="auth-shell">
        <div class="auth-card">
            <div class="auth-content">
                <div class="auth-brand">
                    <div class="auth-badge">Dreamoda Admin Center</div>
                    <h1 class="auth-title">欢迎回来，管理员</h1>
                    <p class="auth-subtitle">为了保护品牌数据，请完成账号登录与二次验证</p>
                </div>

                <div class="step-header">
                    <span class="step-indicator" data-step-indicator>Step 1</span>
                    <h2 class="step-title" data-step-title>账号登录</h2>
                    <p class="step-subtitle" data-step-subtitle>输入管理员账号与密码进入控制台</p>
                </div>

                <div id="auth-message" class="auth-message is-hidden" role="alert" data-type="info">
                    <span id="auth-message-text"></span>
                </div>

                <form id="credentials-form" class="auth-form" autocomplete="on">
                    <div class="form-group">
                        <label class="form-label" for="username">账号</label>
                        <input class="form-control" type="text" id="username" name="username" placeholder="admin" autocomplete="username" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="password">密码</label>
                        <input class="form-control" type="password" id="password" name="password" placeholder="请输入密码" autocomplete="current-password" required>
                    </div>
                    <div class="auth-actions">
                        <button type="submit" class="primary-button" id="login-submit">登录并继续</button>
                        <button type="button" class="ghost-button" id="forgot-password">使用恢复代码登录</button>
                    </div>
                </form>

                <form id="totp-form" class="auth-form is-hidden" autocomplete="off" novalidate>
                    <div class="form-group">
                        <label class="form-label" for="totp-code" data-totp-label>二次验证 · 动态验证码</label>
                        <input class="form-control totp-input" type="text" id="totp-code" name="totp-code" inputmode="numeric" placeholder="000000" maxlength="6" autocomplete="one-time-code" required>
                        <p class="form-hint" data-totp-hint>打开认证器 App，输入当前 6 位验证码。验证码每 30 秒更新一次。</p>
                        <div class="recovery-hint is-hidden" data-recovery-hint>
                        </div>
                    </div>
                    <label class="checkbox-row">
                        <input type="checkbox" id="remember-device">
                        <span>记住此设备 30 天（仅在可信环境勾选）</span>
                    </label>
                    <div class="auth-actions">
                        <button type="submit" class="primary-button" id="totp-submit">验证安全码</button>
                        <div style="display:flex; gap:16px; flex-wrap: wrap;">
                            <button type="button" class="ghost-button" id="use-recovery-code">使用恢复代码</button>
                            <button type="button" class="ghost-button" id="back-to-login">返回账号登录</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>

    </div>

    <script>
        const endpoints = {
            login: '../api/login.php',
            verify2fa: '../api/verify_2fa.php',
            verifyRecovery: '../api/verify_recovery_code.php',
            checkSession: '../api/check_session.php'
        };

        const ui = {
            messageBox: document.getElementById('auth-message'),
            messageText: document.getElementById('auth-message-text'),
            stepIndicator: document.querySelector('[data-step-indicator]'),
            stepTitle: document.querySelector('[data-step-title]'),
            stepSubtitle: document.querySelector('[data-step-subtitle]'),
            loginForm: document.getElementById('credentials-form'),
            totpForm: document.getElementById('totp-form'),
            loginButton: document.getElementById('login-submit'),
            totpButton: document.getElementById('totp-submit'),
            usernameInput: document.getElementById('username'),
            passwordInput: document.getElementById('password'),
            totpInput: document.getElementById('totp-code'),
            totpLabel: document.querySelector('[data-totp-label]'),
            totpHint: document.querySelector('[data-totp-hint]'),
            recoveryHint: document.querySelector('[data-recovery-hint]'),
            rememberDevice: document.getElementById('remember-device'),
            backToLogin: document.getElementById('back-to-login'),
            useRecovery: document.getElementById('use-recovery-code'),
            forgotPassword: document.getElementById('forgot-password'),
        };

        const state = {
            pendingTwoFaToken: null,
            lastUsername: '',
            recoveryMode: false
        };

        const delay = (ms) => new Promise(resolve => setTimeout(resolve, ms));

        function configureVerificationField() {
            if (!ui.totpInput || !ui.totpLabel || !ui.totpHint || !ui.recoveryHint) {
                return;
            }

            const isRecovery = state.recoveryMode;
            ui.totpInput.classList.toggle('is-recovery', isRecovery);

            if (isRecovery) {
                ui.totpLabel.textContent = '二次验证 · 恢复代码';
                ui.totpInput.placeholder = 'XXXXXX-XXXXXX';
                ui.totpInput.setAttribute('inputmode', 'text');
                ui.totpInput.setAttribute('maxlength', '13');
                ui.totpInput.setAttribute('autocomplete', 'off');
                ui.recoveryHint.classList.remove('is-hidden');

                const stripped = ui.totpInput.value.toUpperCase().replace(/[^0-9A-F]/g, '');
                const first = stripped.slice(0, 6);
                const second = stripped.slice(6, 12);
                ui.totpInput.value = second ? `${first}-${second}` : first;
            } else {
                ui.totpLabel.textContent = '二次验证 · 动态验证码';
                ui.totpInput.placeholder = '000000';
                ui.totpInput.setAttribute('inputmode', 'numeric');
                ui.totpInput.setAttribute('maxlength', '6');
                ui.totpInput.setAttribute('autocomplete', 'one-time-code');
                ui.totpHint.textContent = '打开认证器 App，输入当前 6 位验证码。验证码每 30 秒更新一次。';
                ui.recoveryHint.classList.add('is-hidden');
                ui.totpInput.value = ui.totpInput.value.replace(/\D/g, '').slice(0, 6);
            }
        }

        function handleVerificationInput(event) {
            const input = event.target;

            if (state.recoveryMode) {
                const stripped = input.value.toUpperCase().replace(/[^0-9A-F]/g, '');
                const first = stripped.slice(0, 6);
                const second = stripped.slice(6, 12);
                input.value = second ? `${first}-${second}` : first;
            } else {
                input.value = input.value.replace(/\D/g, '').slice(0, 6);
            }
        }

        function showMessage(type, text) {
            ui.messageBox.dataset.type = type;
            ui.messageText.textContent = text;
            ui.messageBox.classList.remove('is-hidden');
        }

        function hideMessage() {
            ui.messageBox.classList.add('is-hidden');
            ui.messageText.textContent = '';
        }

        function switchStep(step) {
            const isLogin = step === 'login';
            ui.loginForm.classList.toggle('is-hidden', !isLogin);
            ui.totpForm.classList.toggle('is-hidden', isLogin);
            ui.stepIndicator.textContent = isLogin ? 'Step 1' : 'Step 2';
            ui.stepTitle.textContent = isLogin ? '账号登录' : (state.recoveryMode ? '恢复代码验证' : '二次验证');
            ui.stepSubtitle.textContent = isLogin
                ? '输入管理员账号与密码进入控制台'
                : (state.recoveryMode
                    ? '输入一次性恢复代码以重置二次验证'
                    : '输入认证器中的 6 位动态验证码完成登录');

            configureVerificationField();

            hideMessage();

            requestAnimationFrame(() => {
                if (isLogin) {
                    ui.usernameInput.focus();
                } else {
                    ui.totpInput.focus();
                }
            });
        }

        function setButtonLoading(button, loading, loadingText = '处理中...') {
            if (!button) return;
            if (loading) {
                button.dataset.originalText = button.textContent;
                button.textContent = loadingText;
                button.disabled = true;
            } else {
                const original = button.dataset.originalText;
                if (original) {
                    button.textContent = original;
                }
                button.disabled = false;
            }
        }

        function persistLoginState() {
            localStorage.setItem('adminLoggedIn', 'true');
            localStorage.setItem('adminLoginTime', Date.now().toString());
        }

        function handleRedirect() {
            setTimeout(() => {
                window.location.href = 'dashboard.php';
            }, 900);
        }

        function handleLoginSuccess(message) {
            state.pendingTwoFaToken = null;
            state.recoveryMode = false;
            ui.rememberDevice.checked = false;
            ui.totpInput.value = '';
            showMessage('success', message || '登录成功，正在跳转后台...');
            persistLoginState();
            handleRedirect();
        }

        async function submitLogin(event) {
            event.preventDefault();
            hideMessage();

            const username = ui.usernameInput.value.trim();
            const password = ui.passwordInput.value;

            if (!username) {
                showMessage('error', '请输入管理员账号');
                ui.usernameInput.focus();
                return;
            }

            if (!password) {
                showMessage('error', '请输入密码');
                ui.passwordInput.focus();
                return;
            }

            setButtonLoading(ui.loginButton, true, '正在验证...');

            try {
                const response = await fetch(endpoints.login, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ username, password })
                });

                const data = await response.json().catch(() => ({}));

                if (!response.ok) {
                    throw new Error(data.message || `登录失败（${response.status}）`);
                }

                if (data.requires2fa) {
                    state.pendingTwoFaToken = data.twoFactorToken || null;
                    state.lastUsername = username;
                    state.recoveryMode = false;
                    switchStep('totp');
                    showMessage('info', data.message || '账号已开启二次验证，请输入动态验证码');
                } else if (data.success) {
                    handleLoginSuccess(data.message);
                } else {
                    throw new Error(data.message || '登录失败，请检查账号与密码');
                }
            } catch (error) {
                showMessage('error', error.message || '网络异常，请稍后重试');
            } finally {
                setButtonLoading(ui.loginButton, false);
            }
        }

        const totpPattern = /^\d{6}$/;
        const recoveryPattern = /^[0-9A-F]{6}-[0-9A-F]{6}$/;

        async function submitTwoFactor(event) {
            event.preventDefault();
            hideMessage();

            if (!state.pendingTwoFaToken) {
                showMessage('warning', '登录会话已过期，请重新登录');
                switchStep('login');
                return;
            }

            let code = ui.totpInput.value.trim();

            if (state.recoveryMode) {
                code = code.toUpperCase();
                ui.totpInput.value = code;
            }

            const isValid = state.recoveryMode ? recoveryPattern.test(code) : totpPattern.test(code);

            if (!code || !isValid) {
                showMessage('error', state.recoveryMode ? '请输入符合格式的恢复代码，例如 F9AF69-FB2025' : '请输入 6 位数字验证码');
                ui.totpInput.focus();
                return;
            }

            setButtonLoading(ui.totpButton, true, '正在验证...');

            try {
                const endpoint = state.recoveryMode ? endpoints.verifyRecovery : endpoints.verify2fa;
                const payload = {
                    token: state.pendingTwoFaToken,
                    rememberDevice: Boolean(ui.rememberDevice.checked)
                };

                if (state.recoveryMode) {
                    payload.recoveryCode = code;
                } else {
                    payload.code = code;
                }

                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify(payload)
                });

                const data = await response.json().catch(() => ({}));

                if (!response.ok) {
                    const message = data.message || '二次验证失败';
                    if (response.status === 440 || response.status === 423 || (response.status === 400 && message.includes('重新登录'))) {
                        state.pendingTwoFaToken = null;
                        state.recoveryMode = false;
                        ui.rememberDevice.checked = false;
                        ui.totpInput.value = '';
                        switchStep('login');
                        showMessage('warning', message);
                        return;
                    }
                    throw new Error(message);
                }

                if (data.success) {
                    handleLoginSuccess(data.message || '验证通过，欢迎回来');
                } else if (data.requireRecovery) {
                    state.recoveryMode = true;
                    ui.rememberDevice.checked = false;
                    ui.totpInput.value = '';
                    switchStep('totp');
                    showMessage('warning', data.message || '需要使用恢复代码完成验证');
                } else {
                    throw new Error(data.message || '验证码不正确，请重新输入');
                }
            } catch (error) {
                showMessage('error', error.message || '网络异常，请稍后重试');
            } finally {
                setButtonLoading(ui.totpButton, false);
            }
        }

        async function checkExistingSession() {
            try {
                const response = await fetch(endpoints.checkSession, { credentials: 'include' });
                const data = await response.json().catch(() => ({}));

                if (response.ok && data.loggedIn) {
                    showMessage('success', '检测到已登录，会自动跳转');
                    persistLoginState();
                    await delay(600);
                    handleRedirect();
                }
            } catch (_) {
                // 忽略网络错误，继续正常流程
            }
        }

        function activateRecoveryMode() {
            if (!state.pendingTwoFaToken) {
                showMessage('warning', '请先完成账号密码登录');
                return;
            }
            state.recoveryMode = true;
            ui.rememberDevice.checked = false;
            ui.totpInput.value = '';
            switchStep('totp');
        }

        function initEventListeners() {
            ui.loginForm.addEventListener('submit', submitLogin);
            ui.totpForm.addEventListener('submit', submitTwoFactor);

            ui.backToLogin.addEventListener('click', () => {
                state.pendingTwoFaToken = null;
                state.recoveryMode = false;
                ui.totpInput.value = '';
                ui.rememberDevice.checked = false;
                switchStep('login');
            });

            ui.totpInput.addEventListener('input', handleVerificationInput);

            ui.useRecovery.addEventListener('click', activateRecoveryMode);

            ui.forgotPassword.addEventListener('click', activateRecoveryMode);

            document.addEventListener('keydown', (event) => {
                if (event.key === 'Escape' && !ui.loginForm.classList.contains('is-hidden')) {
                    hideMessage();
                }
            });
        }

        function init() {
            initEventListeners();
            configureVerificationField();
            switchStep('login');
            checkExistingSession();
        }

        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>