# DreaModa.store - 生产环境配置
RewriteEngine On
RewriteBase /

# 安全配置
ServerSignature Off
Options -Indexes

# MIME types
AddType font/woff2 .woff2
AddType text/javascript .js
AddType application/json .json
AddType image/x-icon .ico

# 压缩配置
<IfModule mod_deflate.c>
    AddOutputFilterByType DEFLATE text/plain
    AddOutputFilterByType DEFLATE text/html
    AddOutputFilterByType DEFLATE text/xml
    AddOutputFilterByType DEFLATE text/css
    AddOutputFilterByType DEFLATE application/xml
    AddOutputFilterByType DEFLATE application/xhtml+xml
    AddOutputFilterByType DEFLATE application/rss+xml
    AddOutputFilterByType DEFLATE text/javascript
    AddOutputFilterByType DEFLATE application/json
    AddOutputFilterByType DEFLATE font/woff2
</IfModule>

# 缓存配置
<IfModule mod_expires.c>
    ExpiresActive On
    ExpiresByType text/css "access plus 1 month"
    ExpiresByType text/javascript "access plus 1 month"
    ExpiresByType application/json "access plus 1 month"
    ExpiresByType font/woff2 "access plus 1 month"
    ExpiresByType image/png "access plus 1 month"
    ExpiresByType image/jpg "access plus 1 month"
    ExpiresByType image/jpeg "access plus 1 month"
    ExpiresByType image/gif "access plus 1 month"
    ExpiresByType image/webp "access plus 1 month"
    ExpiresByType image/x-icon "access plus 1 month"
</IfModule>

# 翻译文件路由
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteRule ^locales/(.*\.json)$ frontend/public/locales/$1 [L]

# 静态资源缓存优化
<IfModule mod_headers.c>
    # 为静态资源设置缓存头
    <FilesMatch "\.(css|js|png|jpg|jpeg|gif|webp|svg|woff|woff2|ttf|eot|json|ico)$">
        Header set Cache-Control "public, max-age=31536000"
        Header unset ETag
    </FilesMatch>
    
    # 为HTML文件设置较短的缓存时间
    <FilesMatch "\.(html|htm)$">
        Header set Cache-Control "public, max-age=3600"
    </FilesMatch>
</IfModule>

# API路由
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteRule ^api/(.*)$ backend/api/$1 [L]

# 管理后台路由
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteRule ^admin/(.*)$ backend/admin/$1 [L]

# 产品图片代理（生产环境）：/product-images/* -> /storage/uploads/product_images/*
RewriteCond %{REQUEST_URI} ^/product-images/
RewriteRule ^product-images/(.*)$ storage/uploads/product_images/$1 [L]

# React应用路由 - 所有非API/Admin请求重定向到index.html
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteCond %{REQUEST_URI} !^/api/
RewriteCond %{REQUEST_URI} !^/admin/
RewriteCond %{REQUEST_URI} !^/storage/uploads/product_images/
RewriteCond %{REQUEST_URI} !^/assets/
RewriteCond %{REQUEST_URI} !^/locales/
RewriteRule ^(.*)$ index.html [L]

# 默认首页
DirectoryIndex index.html

# 安全头
<IfModule mod_headers.c>
    Header always set X-Content-Type-Options nosniff
    Header always set X-Frame-Options DENY
    Header always set Referrer-Policy "strict-origin-when-cross-origin"
    Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains"
    Header always set Content-Security-Policy "default-src 'self'; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://cdnjs.cloudflare.com; font-src 'self' https://fonts.gstatic.com https://cdnjs.cloudflare.com; img-src 'self' data: blob:; script-src 'self' 'unsafe-inline' 'unsafe-eval'; connect-src 'self';"
    Header unset X-Powered-By
    Header unset Expires
    Header unset Pragma
</IfModule>

# 文件上传限制（部分共享主机会禁止 php_value，若报 403/500 请保持注释）
# php_value upload_max_filesize 5M
# php_value post_max_size 5M
# php_value max_execution_time 30
# php_value max_input_time 30